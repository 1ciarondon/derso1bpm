<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de SolicitaÃ§Ãµes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }
        input, select, button {
            padding: 8px;
            margin: 5px;
            font-size: 16px;
        }
        button {
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        #loading {
            display: none;
            font-size: 16px;
            color: blue;
        }
        #mensagem {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2>Consultar a SolicitaÃ§Ã£o</h2>
    
    <label for="matricula">MatrÃ­cula:</label>
    <input type="text" id="matricula" placeholder="Ex: 1234"><br>
    
    <label for="guia">Guia (aba):</label>
    <select id="guia">
        <option value="">Carregando guias...</option>
    </select><br>

    <button onclick="filtrarTabela()">Buscar</button>
    <p id="loading">ðŸ”„ Buscando dados...</p>
    <p id="mensagem"></p>

    <table id="tabela">
        <thead>
            <tr>
                <th>E-mail</th>
                <th>Nome</th>
                <th>Folga</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const corsUrl = "https://derso-1bpm.glitch.me/proxy";
        const targetUrl = "https://script.google.com/macros/s/AKfycbwsIMa4U7n1wnT1kU_WU-sAZv-RfyteZEif6Lf6T-5M/exec";

        function standardizeMatricula(matricula) {
            let num = matricula.replace(/\D/g, '');
            return num.startsWith("1000") ? num : "1000" + num;
        }

        function loadSolicitacoesList(matricula, guia) {
            const url = `${corsUrl}?targetUrl=${encodeURIComponent(targetUrl)}&action=solicitacoes&matricula=${matricula}&sheet=${guia}`;
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.result) {
                        return data.result;
                    } else {
                        console.error("Resposta invÃ¡lida:", data);
                        return [];
                    }
                })
                .catch(error => {
                    console.error("Erro na requisiÃ§Ã£o:", error);
                    return [];
                });
        }

        function carregarAbasDisponiveis() {
            const selectGuia = document.getElementById("guia");
            const url = `${corsUrl}?targetUrl=${encodeURIComponent(targetUrl)}&action=abas`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    selectGuia.innerHTML = "";
                    if (data && data.abas && data.abas.length > 0) {
                        data.abas.forEach(aba => {
                            const option = document.createElement("option");
                            option.value = aba;
                            option.textContent = aba;
                            selectGuia.appendChild(option);
                        });
                    } else {
                        selectGuia.innerHTML = "<option value=''>Nenhuma guia encontrada</option>";
                    }
                })
                .catch(error => {
                    console.error("Erro ao carregar guias:", error);
                    selectGuia.innerHTML = "<option value=''>Erro ao carregar guias</option>";
                });
        }

        function filtrarTabela() {
            const matriculaInput = document.getElementById("matricula");
            const guiaSelect = document.getElementById("guia");
            const matricula = matriculaInput.value.trim();
            const guia = guiaSelect.value;
            const tbody = document.getElementById("tabela").getElementsByTagName("tbody")[0];
            const loadingText = document.getElementById("loading");
            const mensagem = document.getElementById("mensagem");

            tbody.innerHTML = "";
            mensagem.textContent = "";

            if (!matricula || !guia) {
                mensagem.textContent = "Preencha a matrÃ­cula e selecione uma guia.";
                return;
            }

            const matriculaPadronizada = standardizeMatricula(matricula);
            matriculaInput.value = matriculaPadronizada;
            loadingText.style.display = "block";

            loadSolicitacoesList(matriculaPadronizada, guia).then(solicitacoesList => {
                loadingText.style.display = "none";

                if (solicitacoesList.length === 0) {
                    mensagem.textContent = "Nenhuma solicitaÃ§Ã£o encontrada.";
                } else {
                    solicitacoesList.forEach(dado => {
                        const row = tbody.insertRow();
                        row.insertCell(0).textContent = dado["E-MAIL"] || "N/A";
                        row.insertCell(1).textContent = dado["NOME"] || "N/A";
                        row.insertCell(2).textContent = dado["FOLGA"] || "N/A";
                        row.insertCell(3).textContent = dado["DATA"] || "N/A";
                    });
                }
            });
        }

        document.getElementById("matricula").addEventListener("blur", function () {
            this.value = standardizeMatricula(this.value);
        });

        document.getElementById("matricula").addEventListener("keypress", function (event) {
            if (event.key === "Enter") filtrarTabela();
        });

        document.getElementById("guia").addEventListener("keypress", function (event) {
            if (event.key === "Enter") filtrarTabela();
        });

        window.onload = function () {
            carregarAbasDisponiveis();
            document.getElementById("matricula").focus();
        };
    </script>
</body>
</html>
