<!DOCTYPE html>
<html lang="pt-BR">
<head>
Â  <meta charset="UTF-8">
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>SolicitaÃ§Ã£o de Folga - DERSO</title>

Â  <style>
Â  Â :root {
Â  Â  --azul-principal: #0056b3; /* Cor principal um pouco mais profunda */
Â  Â  --azul-escuro: #004d99;
Â  Â  Â  --erro: #dc3545;
Â  Â  Â  --sucesso: #28a745;
Â  Â  Â  --cinza-claro: #f7f7f7;
Â  Â  Â  --cinza-texto: #5a5a5a;
Â  Â  }

Â  Â  body {
Â  Â  background-color: #fcfcfc; /* Fundo levemente fora do branco puro */
Â  Â  font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; /* Aplica a nova fonte */
Â  Â  color: #333;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  min-height: 100vh;
Â  Â  }

Â  Â  .container {
Â  Â  Â  width: 95%;
Â  Â  Â  max-width: 500px;
Â  Â  Â  background-color: var(--cinza-claro);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 30px;
Â  Â  Â  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  position: relative;
Â  Â  }

Â  Â  /* Barra de progresso */
Â  Â  #progressBarContainer {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 5px;
Â  Â  Â  background-color: #e0e0e0;
Â  Â  Â border-radius: 8px 8px 0 0;
Â  Â  Â  overflow: hidden;
Â  Â  }

Â  Â  #progressBar {
Â  Â  Â width: 0%;
Â  Â  Â  height: 100%;
Â  Â  Â  background-color: var(--azul-principal);
Â  Â  Â  transition: width 0.4s ease;
Â  Â  }

Â  Â  /* Logos */
Â  Â  .logos {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 15px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  }

Â  Â  .logos img {
Â  Â  Â  height: 70px;
Â  Â  Â  object-fit: contain;
Â  Â  }

Â  Â  h2, .subtitle {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  line-height: 1.2;
Â  Â  }

Â  Â  h2 {
Â  Â  Â  color: var(--azul-escuro);
Â  Â  Â  font-size: 24px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  margin-bottom: 5px;
Â  Â  }

Â  Â  .subtitle {
Â  Â  Â  color: var(--cinza-texto);
Â  Â  Â  font-size: 15px;
Â  Â  Â  margin-bottom: 25px;
Â  Â  }

Â  Â  .form-group, fieldset {
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  width: 100%;
Â  Â  Â  border: none;
Â  Â  Â  padding: 0;
Â  Â  }

Â  Â  label, legend {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  color: #4a4a4a;
Â  Â  Â  font-weight: 500;
Â  Â  Â  font-size: 14px;
Â  Â  }

Â  Â  .form-group input:not([type="radio"]),
Â  Â  .form-group select {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 12px 15px;
Â  Â  Â  font-size: 15px;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  transition: border-color 0.3s ease, box-shadow 0.3s ease;
Â  Â  }

Â  Â  .form-group input:not([type="radio"]):focus,
Â  Â  .form-group select:focus {
Â  Â  Â  border-color: var(--azul-principal);
Â  Â  Â  outline: none;
Â  Â  Â  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
Â  Â  }

Â  Â  input[readonly] {
Â  Â  Â  background-color: #e9ecef;
Â  Â  Â  cursor: not-allowed;
Â  Â  }

Â  Â  input[id="matricula"]::placeholder {
Â  Â  Â  color: #aaa;
Â  Â  }

Â  /* Novo CSS para os botÃµes de alternÃ¢ncia (Toggle Buttons) */
.radio-group-buttons {
Â  display: flex;
Â  flex-wrap: wrap;
Â  gap: 10px;
Â  margin-top: 10px;
}

.radio-group-buttons input[type="radio"] {
Â  /* Esconde o radio button nativo */
Â  display: none;
}

.radio-group-buttons label {
Â  /* Estiliza o label como um botÃ£o */
Â  display: inline-block;
Â  padding: 8px 12px;
Â  border: 1px solid #ccc;
Â  border-radius: 6px;
Â  cursor: pointer;
Â  font-size: 14px;
Â  transition: background-color 0.2s, border-color 0.2s, color 0.2s;
Â  user-select: none;
Â  /* text-transform: uppercase; <--- REMOVIDO/COMENTADO */
}

.radio-group-buttons input[type="radio"]:checked + label {
Â  /* Estilo quando o botÃ£o estÃ¡ selecionado */
Â  background-color: var(--azul-principal);
Â  color: #fff;
Â  border-color: var(--azul-principal);
Â  font-weight: 600;
Â  box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
}

.radio-group-buttons label:hover {
Â  /* Estilo ao passar o mouse */
Â  background-color: var(--cinza-claro);
Â  border-color: var(--azul-principal);
}

/* Garante que em telas pequenas as opÃ§Ãµes continuem organizadas */
@media (max-width: 576px) {
Â  /* Ajuste para que as opÃ§Ãµes continuem em linha, se houver espaÃ§o, ou quebrem */
Â  .radio-group-buttons {
Â  Â  justify-content: center; /* Centraliza no mÃ³vel */
Â  }

}

Â  Â  /* Feedback visual para campos */
.form-group input.is-valid {
Â  border-color: var(--sucesso) !important;
Â  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2) !important; /* Cor de sucesso */
}

.form-group input.is-invalid {
Â  border-color: var(--erro) !important;
Â  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important; /* Cor de erro */
}

Â  Â  .button {
Â  Â  Â  background-color: var(--azul-principal);
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 14px 20px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  transition: background-color 0.3s ease, transform 0.2s ease;
Â  Â  Â  display: block;
Â  Â  Â  width: 100%;
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  .button:hover {
Â  Â  Â  background-color: #0056b3;
Â  Â  Â  transform: translateY(-2px);
Â  Â  }

Â  Â  .button:active {
Â  Â  Â  transform: translateY(0);
Â  Â  }

Â  Â  .error {
Â  Â  Â  color: var(--erro);
Â  Â  Â margin-top: 5px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  font-weight: 500;
Â  Â  }

Â  Â  .required-star {
Â  Â  Â  color: var(--erro);
Â  Â  Â  margin-left: 2px;
Â  Â  }

Â  Â  .info-message {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-size: 14px;
Â  Â  Â  display: none;
Â  Â  }

Â  Â  .info-message.success {
Â  Â  Â background-color: #d4edda;
Â  Â  Â  color: #155724;
Â  Â  }

Â  Â  .info-message.error {
Â  Â  Â  background-color: #f8d7da;
Â  Â  Â  color: #721c24;
Â  Â  }

Â  Â  .footer {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-top: 25px;
Â  Â  Â  font-size: 12px;
Â  Â  Â  color: #5a5a5a;
Â  Â  }

Â  Â  @media (max-width: 576px) {
Â  Â  Â  .container { padding: 20px; }
Â  Â  Â  h2 { font-size: 20px; }
Â  Â  Â  .subtitle { font-size: 13px; }
Â  Â  Â  .form-group input:not([type="radio"]), .form-group select { font-size: 14px; }
Â  Â  Â  .button { font-size: 14px; padding: 12px 15px; }
Â  Â  Â  .radio-group { flex-direction: column; gap: 10px; }
Â  Â  Â  .logos img { height: 50px; }
Â  Â  }

/* ğŸš¨ CorreÃ§Ãµes de Sintaxe (Removidas do HTML, Adicionadas aqui) */
.hidden {
Â  Â  display: none !important;
}

.spinner {
Â  Â  border: 4px solid rgba(0, 0, 0, 0.1);
Â  Â  border-top: 4px solid var(--azul-principal);
Â  Â  border-radius: 50%;
Â  Â  width: 30px;
Â  Â  height: 30px;
Â  Â  animation: spin 1s linear infinite;
Â  Â  margin: 20px auto;
}

@keyframes spin {
Â  Â  0% { transform: rotate(0deg); }
Â  Â  100% { transform: rotate(360deg); }
}

Â  </style>
</head>
<body>
Â <div class="container" id="formulario">
Â  Â  <div id="progressBarContainer"><div id="progressBar"></div></div>
Â  Â Â 
Â  Â  <div id="loadingState" style="text-align: center; padding: 40px 0;">
Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  <p class="subtitle" id="loadingMessage">Carregando dados de funcionÃ¡rios e verificando prazo...</p>
Â  Â  </div>
Â  Â  <div class="logos">
Â  Â  Â  <img src="https://rondonia.ro.gov.br/wp-content/uploads/2024/09/Brasao-PMRO-370x523.png" alt="PMRO">
Â  Â  Â  <img src="https://museu.pm.ro.gov.br/wp-content/uploads/2024/05/1-bpm-3.png" alt="1Âº BPM">
Â  Â  </div>

Â  Â  <h2>DERSO 1Âº BPM</h2>
Â  Â  <p class="subtitle">FormulÃ¡rio de SolicitaÃ§Ã£o de Folga</p>

Â  Â <form id="dersoForm" class="hidden">
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â <label for="email">E-mail:</label>
Â  Â  Â  Â  <input type="email" id="email" name="email" list="emailProviders" required autofocus>
Â  Â  Â  Â  <datalist id="emailProviders"></datalist>
Â  Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  <label for="matricula">MatrÃ­cula:</label>
Â  Â  <input type="text" id="matricula" name="matricula" required placeholder="Ex: 12345 ou 100012345" autocomplete="off">
Â  Â  <div id="matriculaError" class="error"></div>
</div>

Â  Â  Â <div class="form-group">
Â  <label for="nome">Nome:</label>
Â  <input type="text" id="nome" name="nome" readonly required>
</div>

<fieldset>
Â  <legend>Tipo de Folga<span class="required-star">*</span>:</legend>
Â  <div class="radio-group-buttons">
Â  Â  <input type="radio" id="folga24H" name="folga" value="24H" required><label for="folga24H">24h</label>
Â  Â  <input type="radio" id="folga48H" name="folga" value="48H"><label for="folga48H">48h</label>
Â  Â  <input type="radio" id="folga72H" name="folga" value="72H"><label for="folga72H">72h</label>
Â  Â  <input type="radio" id="folga96H" name="folga" value="96H"><label for="folga96H">96h</label>
Â  Â  <input type="radio" id="folgaLE" name="folga" value="FOLGA LE"><label for="folgaLE">LE</label>
Â  Â  <input type="radio" id="folga1" name="folga" value="1Âª Folga"><label for="folga1">1Âª</label>
Â  Â  <input type="radio" id="folga2" name="folga" value="2Âª Folga"><label for="folga2">2Âª</label>
Â  Â  <input type="radio" id="folgaExp" name="folga" value="Expediente"><label for="folgaExp">EXP</label>
Â  </div>

Â  <div id="duplicateError" class="error"></div>

</fieldset>


Â  Â  <div class="form-group">
Â  <label for="data">Data:</label>
Â  <input type="date" id="data" name="data" required>
Â  <div id="dateLimitMessage" class="subtitle" style="margin-top: 5px; margin-bottom: 0; font-size: 12px; text-align: left;"></div>
</div>

Â  Â  Â <button type="submit" class="button">
Â  Â  <span aria-hidden="true">â¡ï¸</span> Enviar SolicitaÃ§Ã£o
</button>
Â  Â  Â Â 
Â  Â  </form>
Â  Â  <div id="statusMessage" class="info-message"></div>
Â  Â  <div class="footer" id="footerText"></div>
Â  </div>

Â <script>
    // ğŸš€ NOVO: FunÃ§Ã£o utilitÃ¡ria para "atrasar" a execuÃ§Ã£o (debounce)
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

Â  Â  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwe2vseE23YEgIwPxOHiXlv3COUfJYVRsMSTYov0v78zSgDZtOeTCYx1J8GOzlzKhwDFg/exec";
Â  Â  const emailProviders = ["gmail.com","hotmail.com","outlook.com","yahoo.com","terra.com.br","bol.com.br"];
Â  Â  window.employeeList = {};

Â  Â  const progressBar = document.getElementById("progressBar");
Â  Â  const formDiv = document.getElementById("dersoForm");
    const loadingStateDiv = document.getElementById("loadingState");

Â  Â  function setProgress(percent) {
Â  Â  Â  progressBar.style.width = percent + "%";
Â  Â  }

Â  Â  function updateEmailDatalist() {
Â  Â  Â  const emailInput = document.getElementById("email");
Â  Â  Â  const datalist = document.getElementById("emailProviders");
Â  Â  Â  const value = emailInput.value;
Â  Â  Â  const atIndex = value.indexOf("@");
Â  Â  Â  if (atIndex === -1) { datalist.innerHTML = ""; return; }
Â  Â  Â  const domainPart = value.slice(atIndex + 1).toLowerCase();
Â  Â  Â  const filtered = emailProviders.filter(p => p.startsWith(domainPart));
Â  Â  Â  datalist.innerHTML = "";
Â  Â  Â  filtered.forEach(p => { const option = document.createElement("option"); option.value = value.slice(0, atIndex+1)+p; datalist.appendChild(option); });
Â  Â  }

Â  Â  function standardizeMatricula(m) {
Â  Â  Â  let num = m.replace(/\D/g,'').slice(0,9);
Â  Â  Â  return num.startsWith("1000") ? num : "1000"+num;
Â  Â  }

Â  Â  // FunÃ§Ã£o de Checagem de Duplicidade (Async)
Â  Â  async function checkDuplicity(matricula, data, folga) {
Â  Â  Â  Â  // O SCRIPT_URL precisa estar configurado para aceitar a aÃ§Ã£o 'check_duplicidade'
Â  Â  Â  Â  const url = `${SCRIPT_URL}?action=check_duplicidade&matricula=${matricula}&data=${data}&folga=${folga}`;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  const dataJson = await response.json();
Â  Â  Â  Â  Â  // Verifica se a resposta contÃ©m a flag de duplicidade
Â  Â  Â  Â  Â  return dataJson.duplicado === true;Â 
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  // Em caso de falha na checagem, assume que NÃƒO Ã‰ duplicado, mas avisa
Â  Â  Â  Â  Â  console.error("Falha ao verificar duplicidade:", e);
Â  Â  Â  Â  Â  showMessage("âš ï¸ Erro ao verificar duplicidade. Tentando enviar...", "error");
Â  Â  Â  Â  Â  return false; // Permite o envio para evitar bloqueio indevido
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function loadEmployeeList() {
Â  Â  Â  Â  setProgress(20);
Â  Â  Â  Â  const matriculaInput = document.getElementById("matricula");
Â  Â  Â  Â  matriculaInput.disabled = true;Â 
Â  Â  Â  Â  matriculaInput.placeholder = "Carregando lista de funcionÃ¡rios...";

Â  Â  Â  Â  fetch(SCRIPT_URL+"?action=lista")
Â  Â  Â  Â  .then(r => r.json())
Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  if(data.error) throw new Error(data.error);
Â  Â  Â  Â  Â  Â  window.employeeList = data;
Â  Â  Â  Â  Â  Â  setProgress(40);
Â  Â  Â  Â  Â  Â  matriculaInput.disabled = false;Â 
Â  Â  Â  Â  Â  Â  matriculaInput.placeholder = "Ex: 12345 ou 100012345";
Â  Â  Â  Â  }).catch(()=>{
Â  Â  Â  Â  Â  Â  document.getElementById("matriculaError").textContent="Erro ao carregar lista de funcionÃ¡rios.";
Â  Â  Â  Â  Â  Â  showPersistentMessage("âš ï¸ Erro grave ao carregar dados de funcionÃ¡rios. Tente recarregar a pÃ¡gina.", "error");
Â  Â  Â  Â  Â  Â  formDiv.classList.add("hidden");
Â  Â  Â  Â  Â  Â  loadingStateDiv.classList.add("hidden"); // Oculta o loading em caso de falha
Â  Â  Â  Â  });
Â  Â  }

Â  Â function checkMatricula() {
Â  Â  Â  Â  const m = document.getElementById("matricula");
Â  Â  Â  Â  const n = document.getElementById("nome");
Â  Â  Â  Â  const e = document.getElementById("matriculaError");
Â  Â  Â  Â  const standardized = standardizeMatricula(m.value);
Â Â 
Â  Â  Â  Â  m.classList.remove("is-valid", "is-invalid");

Â  Â  Â  Â  m.value = standardized;
Â  Â  Â  Â  if(window.employeeList[standardized]) {Â 
Â  Â  Â  Â  Â  Â  n.value = window.employeeList[standardized];Â 
Â  Â  Â  Â  Â  Â  e.textContent = "";Â 
Â  Â  Â  Â  Â  Â  m.classList.add("is-valid");Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  else {Â 
Â  Â  Â  Â  Â  Â  n.value = "";Â 
Â  Â  Â  Â  Â  Â  e.textContent = "MatrÃ­cula nÃ£o encontrada!";Â 
Â  Â  Â  Â  Â  Â  m.classList.add("is-invalid");Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function setDateLimits() {
Â  Â  Â  Â  const dateInput = document.getElementById("data");
Â  Â  Â  Â  const messageDiv = document.getElementById("dateLimitMessage");Â 

Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  let nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
Â  Â  Â  Â  let nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0);

Â  Â  Â  Â  dateInput.min = nextMonthStart.toISOString().split("T")[0];
Â  Â  Â  Â  dateInput.max = nextMonthEnd.toISOString().split("T")[0];

Â  Â  Â  Â  const startDay = nextMonthStart.getDate().toString().padStart(2, '0');
Â  Â  Â  Â  const startMonth = (nextMonthStart.getMonth() + 1).toString().padStart(2, '0');
Â  Â  Â  Â  const endDay = nextMonthEnd.getDate().toString().padStart(2, '0');
Â  Â  Â  Â  const endMonth = (nextMonthEnd.getMonth() + 1).toString().padStart(2, '0');

Â  Â  Â  Â  messageDiv.textContent = `PerÃ­odo de folga permitido: ${startDay}/${startMonth} a ${endDay}/${endMonth}.`;
Â  Â  }

Â  Â  function formatDateBR(d) {
Â  Â  Â  if(!d) return "";
Â  Â  Â  const [y,m,day] = d.split("-");
Â  Â  Â  return `${day}/${m}/${y}`;
Â  Â  }

Â  Â  // FunÃ§Ã£o de SubmissÃ£o Atualizada com Checagem de Duplicidade (Async)
Â  Â  async function submitForm(e){
Â  Â  Â  e.preventDefault();
Â  Â  Â  const form = document.getElementById("dersoForm");
Â  Â  Â  const btn = document.querySelector(".button");
Â  Â  Â  const matriculaInput = document.getElementById("matricula");
Â  Â  Â  const dataValue = document.getElementById("data").value;
Â  Â  Â  const folgaRadio = document.querySelector('input[name="folga"]:checked');
Â  Â  Â  const duplicateError = document.getElementById("duplicateError");
Â  Â  Â  const nomeValue = document.getElementById("nome").value.trim();
Â  Â  Â  const dataBR = formatDateBR(dataValue);

Â  Â  Â  duplicateError.textContent = "";
Â  Â  Â Â 
Â  Â  Â  // ValidaÃ§Ãµes bÃ¡sicas
Â  Â  Â  if(!folgaRadio){
Â  Â  Â  Â  duplicateError.textContent = "Selecione um Tipo de Folga.";Â 
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if(nomeValue === "" || matriculaInput.classList.contains("is-invalid")){
Â  Â  Â  Â  document.getElementById("matriculaError").textContent = nomeValue === "" ? "MatrÃ­cula invÃ¡lida. Verifique o nÃºmero." : "MatrÃ­cula invÃ¡lida.";Â 
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  btn.disabled = true;
Â  Â  Â  setProgress(60);

Â  Â  Â  try {
Â  Â  Â  Â  Â  // 1. VERIFICAÃ‡ÃƒO DE DUPLICIDADE
Â  Â  Â  Â  Â  const isDuplicate = await checkDuplicity(
Â  Â  Â  Â  Â  Â  matriculaInput.value,Â 
Â  Â  Â  Â  Â  Â  dataBR,Â 
Â  Â  Â  Â  Â  Â  folgaRadio.value
Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  if (isDuplicate) {
Â  Â  Â  Â  Â  Â  showMessage(`âš ï¸ SolicitaÃ§Ã£o DUPLICADA. VocÃª jÃ¡ solicitou **${folgaRadio.value}** para ${dataBR}.`, "error");
Â  Â  Â  Â  Â  Â  return; // Para a submissÃ£o
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // 2. ENVIO FINAL
Â  Â  Â  Â  Â  const fd = new FormData(form);
Â  Â  Â  Â  Â  fd.set("data", dataBR);
Â  Â  Â  Â  Â  fd.set("folga", folgaRadio.value); // Garante que a folga checada Ã© a que Ã© enviada

Â  Â  Â  Â  Â  const response = await fetch(SCRIPT_URL, {method: "POST", body: new URLSearchParams(fd)});
Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  if(data.success){
Â  Â  Â  Â  Â  Â  showMessage("âœ… SolicitaÃ§Ã£o enviada com sucesso! Um resumo foi enviado para o seu e-mail.","success");Â 
Â  Â  Â  Â  Â  Â  form.reset();Â 
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showMessage("âš ï¸ "+(data.error||"Erro ao enviar. Tente novamente."),"error");
Â  Â  Â  Â  Â  }

Â  Â  Â  } catch(error) {
Â  Â  Â  Â  console.error("Erro na duplicidade ou envio:", error);
Â  Â  Â  Â  showMessage("âš ï¸ Falha na conexÃ£o ou processamento. Tente novamente.", "error");
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  setProgress(100);
Â  Â  Â  Â  setTimeout(()=>setProgress(0), 500);
Â  Â  Â  }
Â  Â  }

Â  // FunÃ§Ã£o para mostrar mensagens temporÃ¡rias (sucesso/erro do submit)
function showMessage(msg, type = "success") {
Â  const div = document.getElementById("statusMessage");
Â  div.className = "info-message " + type;
Â  div.innerHTML = msg; // Usamos innerHTML para suportar negrito/emojis
Â  div.style.display = "block";
Â  // A mensagem TEMPORÃRIA Ã© oculta apÃ³s 5 segundos
Â  setTimeout(() => { div.style.display = "none"; }, 5000);Â 
}

// FunÃ§Ã£o para mostrar a mensagem de PRAZO (deve ser persistente)
function showPersistentMessage(msg, type = "success") {
Â  const div = document.getElementById("statusMessage");
Â  div.className = "info-message " + type;
Â  div.innerHTML = msg;
Â  div.style.display = "block";
Â  // A mensagem PERSISTENTE nÃ£o Ã© oculta.
}Â Â 
Â  Â Â 
Â function initializeForm(){
Â  loadEmployeeList();
Â  setDateLimits();
Â  const footer = document.getElementById("footerText");Â 

Â  fetch(SCRIPT_URL+"?action=datas")
Â  .then(r=>r.json())
Â  .then(data=>{
Â  Â  Â  if(data.error) {
Â  Â  Â  Â  Â  showPersistentMessage(`âš ï¸ Erro ao verificar o prazo: ${data.error}`, "error");
Â  Â  Â  Â  Â  formDiv.style.display = "none";Â 
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const agora = new Date();
Â  Â  Â  const abertura = new Date(data.abertura);
Â  Â  Â  const fechamento = new Date(data.fechamento);

Â  Â  Â  if(agora < abertura || agora > fechamento){
Â  Â  Â  Â  // PerÃ­odo Fechado
Â  Â  Â  Â  const msg = agora < abertura
Â  Â  Â  Â  Â  Â  ? `â³ **Abertura:** ${abertura.toLocaleString("pt-BR")}`
Â  Â  Â  Â  Â  Â  : `â›” **Encerrado:** ${fechamento.toLocaleString("pt-BR")}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  showPersistentMessage(msg, "error");
Â  Â  Â  Â  formDiv.style.display = "none";Â 
Â  Â  Â  } else {
Â  Â  Â  Â  // PerÃ­odo Aberto: Mostra o formulÃ¡rio e o tempo restante
Â  Â  Â  Â formDiv.classList.remove("hidden");
Â  Â  Â  Â Â 
Â  Â  Â  Â  const diffTime = fechamento.getTime() - agora.getTime();
Â  Â  Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const msg = `ğŸš¨ **AtenÃ§Ã£o!** Restam **${diffDays} dia(s)** para o fechamento do formulÃ¡rio em ${fechamento.toLocaleDateString("pt-BR")} Ã s ${fechamento.toLocaleTimeString("pt-BR")}.`;

Â  Â  Â  Â  showPersistentMessage(msg, "success");
Â  Â  Â  }
      // Oculta o loading apÃ³s o carregamento e verificaÃ§Ã£o do prazo
      loadingStateDiv.classList.add("hidden"); 
Â  })
Â  .catch(error => {
Â  Â  // Falha geral na comunicaÃ§Ã£o com o script de datas
Â  Â  showPersistentMessage(`âš ï¸ Falha ao conectar com o servidor. Verifique o link do script.`, "error");
Â  Â  formDiv.style.display = "none";
    // Oculta o loading em caso de falha de prazo/conexÃ£o
    loadingStateDiv.classList.add("hidden");
Â  });


Â  const now = new Date();
Â  const mes = now.getMonth()+1; const ano = now.getFullYear();
Â  footer.textContent=`Desenvolvido na 1Âª Cia do 1Âº BPM pelo PVSA Pedro Porto - ${mes.toString().padStart(2,'0')}/${ano}`;
}
Â  Â Â 
Â  Â  document.addEventListener("DOMContentLoaded",()=>{
Â  Â  Â  initializeForm();
      // Aplica o debounce para a validaÃ§Ã£o enquanto digita
      document.getElementById("matricula").addEventListener("input", debounce(checkMatricula, 300));
Â  Â  Â  document.getElementById("matricula").addEventListener("blur",checkMatricula);
Â  Â  Â  document.getElementById("email").addEventListener("input",updateEmailDatalist);
Â  Â  Â  document.getElementById("dersoForm").addEventListener("submit",submitForm);
Â  Â  });
Â  </script>
</body>
</html>
